<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <title>QRCode.react Demo</title>
  <style>
    /* .container {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }
      .output {
        margin-left: 1rem;
      }
      .container .output textarea{
        display: none;
      }
      @media only screen and (max-width: 600px) {
        .container {
          flex-direction: column;
        }
      } */

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: #1f2937;
      background-color: #f9fafb;
      margin: 0;
      padding: 20px;
    }

    .container .output textarea {
      display: none;
    }

    #demo {
      max-width: 768px;
      margin: 0 auto;
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Header section */
    #demo .container:first-child {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    #demo h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    #demo h1 a {
      color: #6366f1;
      text-decoration: none;
    }

    #demo h1 a:hover {
      text-decoration: underline;
    }

    #demo p {
      color: #6b7280;
      margin: 0.5rem 0 1rem;
    }

    code {
      background-color: #f3f4f6;
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-family: monospace;
    }

    /* Demo selector */
    #demo select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }

    hr {
      border: 0;
      height: 1px;
      background-color: #e5e7eb;
      margin: 1.5rem 0;
    }

    /* Main two-column layout */
    #demo>.container:last-child {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      #demo>.container:last-child {
        flex-direction: row;
      }
    }

    .form {
      flex: 1;
      padding-right: 1.5rem;
    }

    @media (min-width: 768px) {
      .form {
        width: 50%;
      }
    }

    .output {
      flex: 1;
    }

    @media (min-width: 768px) {
      .output {
        width: 50%;
        padding-left: 1.5rem;
      }
    }

    /* Form styles */


    .form label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form input:not([type="checkbox"]):not([type="color"]),
    .form select,
    .form textarea {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background: #f9fafb;
    }

    .form input:focus,
    .form select:focus,
    .form textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* Color input styles */
    .form input[type="color"] {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    .color-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .color-input-container span {
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* Checkbox styles */
    .form input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: #6366f1;
      margin-right: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    /* Fieldset styles */
    .form fieldset {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .form fieldset legend {
      padding: 0 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }

    /* Output styles */
    .output>div {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background: #f9fafb;
    }

    .output h2 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 1rem;
    }

    .output pre {
      display: inline;
      font-family: monospace;
      background-color: #e0e7ff;
      color: #4338ca;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
    }

    .output textarea {
      width: 100%;
      min-height: 200px;
      font-family: monospace;
      font-size: 0.75rem;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      resize: none;
    }

    .output svg,
    .output canvas {
      display: block;
      margin: 0 auto;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background: white;
      max-width: 100%;
    }

    /* Range input */
    input[type="range"] {
      width: 100%;
      height: 0.5rem;
      background: #e5e7eb;
      border-radius: 0.25rem;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 1rem;
      height: 1rem;
      background: #6366f1;
      border-radius: 50%;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .download-btn {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .download-btn:hover {
      background-color: #4338ca;
    }
  </style>
</head>

<body>
  <div id="demo">

  </div>

  <div id="demo" class="output">
    <div>
      <h2>
        <pre>QRCodeSVG</pre>
      </h2>
      <div class="button-group">
        <button class="download-btn" data-type="svg">Download SVG</button>
      </div>
      <!-- ... phần hiển thị SVG hiện tại ... -->
    </div>
    <div>
      <h2>
        <pre>QRCodeCanvas</pre>
      </h2>
      <div class="button-group">
        <button class="download-btn" data-type="png">Download PNG</button>
      </div>
      <!-- ... phần hiển thị Canvas hiện tại ... -->
    </div>
  </div>

  <script src="js/demo.js"></script>
  <script>
    // Hàm download chung
    function downloadFile(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    // Download SVG
    function downloadSVG() {
      try {
        const svg = document.querySelector('#demo .output svg').cloneNode(true);
        svg.querySelector('image')?.removeAttribute('href'); // Xử lý CORS cho image

        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svg);

        // Thêm XML namespace nếu thiếu
        if (!source.includes('xmlns="http://www.w3.org/2000/svg"')) {
          source = source.replace(/<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        // Tạo blob
        const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        downloadFile(url, 'QRCodeSVG.svg');
      } catch (error) {
        console.error('SVG Error:', error);
        alert('Lỗi khi tạo SVG. Vui lòng thử lại.');
      }
    }

    // Download PNG (giải pháp mới đáng tin cậy)
    function downloadPNG() {
      return new Promise((resolve) => {
        setTimeout(() => {
          try {
            const canvas = document.querySelector('#demo .output canvas');
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');

            // Đặt kích thước canvas
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;

            // Vẽ nền trắng trước
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // Vẽ QR code lên canvas
            ctx.drawImage(canvas, 0, 0);

            // Thử 3 cách khác nhau để tạo PNG
            const methods = [
              () => tempCanvas.toDataURL('image/png'),
              () => canvas.toDataURL('image/png'),
              () => {
                const img = new Image();
                img.src = canvas.toDataURL();
                return tempCanvas.toDataURL('image/png');
              }
            ];

            // Thử lần lượt các phương pháp
            const tryMethods = (index) => {
              try {
                const url = methods[index]();
                if (url && url.startsWith('data:image/png')) {
                  downloadFile(url, 'QRCodePNG.png');
                  resolve(true);
                } else if (index < methods.length - 1) {
                  tryMethods(index + 1);
                } else {
                  throw new Error('Tất cả phương pháp tạo PNG đều thất bại');
                }
              } catch (e) {
                if (index < methods.length - 1) {
                  tryMethods(index + 1);
                } else {
                  console.error('PNG Error:', e);
                  alert('Lỗi khi tạo PNG. Vui lòng thử lại hoặc dùng SVG.');
                  resolve(false);
                }
              }
            };

            tryMethods(0);
          } catch (error) {
            console.error('PNG Processing Error:', error);
            alert('Lỗi nghiêm trọng khi xử lý PNG.');
            resolve(false);
          }
        }, 200); // Delay để đảm bảo canvas render xong
      });
    }

    // Gắn sự kiện click
    document.querySelectorAll('.download-btn').forEach(btn => {
      btn.addEventListener('click', async function () {
        const type = this.getAttribute('data-type');

        if (type === 'svg') {
          downloadSVG();
        } else if (type === 'png') {
          this.disabled = true;
          this.textContent = 'Đang tạo...';

          await downloadPNG();

          this.disabled = false;
          this.textContent = 'Download PNG';
        }
      });
    });
  </script>

  <style>
    /* Cập nhật style nút để phản ánh trạng thái */
    .download-btn {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      position: relative;
    }

    .download-btn:hover {
      background-color: #4338ca;
    }

    .download-btn:disabled {
      background-color: #94a3b8;
      cursor: wait;
    }

    .download-btn.loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }
  </style>
</body>

</html>